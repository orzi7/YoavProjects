#include <Keypad.h>
#include <LiquidCrystal_I2C.h>
#include "Servo.h"

LiquidCrystal_I2C lcd(0x27,16,2);
Servo myservo;

#define servoPin 2
#define S0 14
#define S1 15
#define S2 16
#define S3 17
#define sensorOut 18

const byte ROWS = 4;
const byte COLS = 3;

char hexaKeys[ROWS][COLS] = {
  {'1', '2', '3'},
  {'4', '5', '6'},
  {'7', '8', '9'},
  {'*', '0', '#'}
};

byte rowPins[ROWS] = {9, 8, 7, 6};
byte colPins[COLS] = {5, 4, 3};

Keypad customKeypad = Keypad(makeKeymap(hexaKeys), rowPins, colPins, ROWS, COLS);

int redFrequency = 0;
int greenFrequency = 0;
int blueFrequency = 0;

int redColor;
int greenColor;
int blueColor;

String result;
String secretCode;
String colorOrder = "BGR";
String detectedColors = "";

int attempts = 1;
int colorAttempts = 1;

int stage = 1;

void setup() {
  Serial.begin(9600);

  myservo.attach(servoPin);

  lcd.init();
  lcd.clear();         
  lcd.backlight();

  pinMode(11, OUTPUT);
  pinMode(12, OUTPUT);
  pinMode(19, OUTPUT);

  lcd.setCursor(0,0);
  lcd.print("Guess the 4 nums");
  lcd.setCursor(0,1);
  lcd.print("or world ends!");

  randomSeed(analogRead(A0));
  secretCode = randomNum();

  pinMode(S0, OUTPUT);
  pinMode(S1, OUTPUT);
  pinMode(S2, OUTPUT);
  pinMode(S3, OUTPUT);

  myservo.write(0);
  delay(1000);
  
  pinMode(sensorOut, INPUT);
  
  digitalWrite(S0,HIGH);
  digitalWrite(S1,LOW);
}

String randomNum() {
  int randNum = random(1000, 10000);
  randNum = 6392;
  return String(randNum);
}

bool checkColorOrder(String triedOrder, String realOrder) {
  if (triedOrder == realOrder) {
    return true;
  } else {
    return false;
  }
}

bool check(String triedCode, String realCode) {
  if (triedCode == realCode) {
    lcd.clear();
    lcd.setCursor(2,0);
    lcd.print("yahhhhh");
    digitalWrite(19, LOW);
    digitalWrite(12, HIGH);
    digitalWrite(11, LOW);
    return true;
  } else {
    //lcd.clear();
    //lcd.setCursor(2,0);
  }
  if (triedCode > realCode) {
    digitalWrite(11, HIGH);
    digitalWrite(12, LOW);
    digitalWrite(19, LOW);
    return false;
  }

  if (triedCode < realCode) {
    digitalWrite(11, LOW);
    digitalWrite(12, LOW);
    digitalWrite(19, HIGH);
    return false;
  } 
}

void loop() {
  if (stage == 1) {
    delay(200);
    digitalWrite(11, LOW);
    digitalWrite(12, LOW);
    digitalWrite(19, LOW);
    char customKey = customKeypad.getKey();

    if (customKey) {
      if (customKey == '*') {
        result.remove(result.length() - 1);
      }
      else {
        result += customKey;
      }
      lcd.clear();
      lcd.setCursor(2,0);
      lcd.print(result);
    }

    if (result.length() == 4) {
      bool correct = check(result, secretCode);
      if (correct) {
        secretCode = randomNum();
        lcd.clear();
        lcd.setCursor(2,0);
        lcd.print("you made it in: ");
        lcd.setCursor(2,1);
        lcd.print(attempts);
        lcd.setCursor(4,1);
        lcd.print("attempts");
        digitalWrite(12, LOW);
        delay(2000);
        lcd.clear();
        lcd.setCursor(0,0);
        lcd.print("Guess the 3 colors");
        lcd.setCursor(0,1);
        lcd.print("or world ends!");
        delay(2000);
        stage = 2;
      } else {
        attempts += 1;
        if (result.toInt() > secretCode.toInt()) {
          lcd.clear();
          lcd.setCursor(2,0);
          lcd.print("Lower!");
        }
        else {
          lcd.clear();
          lcd.setCursor(2,0);
          lcd.print("Higher!");
        }
      }
      result = "";
    }
  }

//--------------------------------------------------------------------------------------------------------------

  if (stage == 2) {
    char customKey = customKeypad.getKey();
      if (customKey) {
        if (customKey == '*') {
          detectedColors.remove(detectedColors.length() - 1);
          lcd.clear();
          lcd.setCursor(2,0);
          lcd.print(detectedColors);
        }
      }


    if (customKey == '#') {

      digitalWrite(S2,LOW);
      digitalWrite(S3,LOW);
      
      redFrequency = pulseIn(sensorOut, LOW);
      redColor = map(redFrequency, 70, 120, 255,0);

      digitalWrite(S2,HIGH);
      digitalWrite(S3,HIGH);
      
      greenFrequency = pulseIn(sensorOut, LOW);
      greenColor = map(greenFrequency, 100, 199, 255, 0);

      digitalWrite(S2,LOW);
      digitalWrite(S3,HIGH);
      
      blueFrequency = pulseIn(sensorOut, LOW);
      blueColor = map(blueFrequency, 38, 84, 255, 0);

      if(redColor > greenColor && redColor > blueColor){
        detectedColors += "R";
      }
      if(greenColor > redColor && greenColor > blueColor){
        detectedColors += "G";
      }
      if(blueColor > redColor && blueColor > greenColor){
        detectedColors += "B";
      }

      lcd.clear();
      lcd.setCursor(2,0);
      lcd.print(detectedColors);

      if (detectedColors.length() == 3) {
        delay(500);
        bool rightOrder = checkColorOrder(detectedColors, colorOrder);
        if (rightOrder) {
          digitalWrite(12, HIGH);
          lcd.clear();
          lcd.setCursor(2,0);
          lcd.print("you made it in: ");
          lcd.setCursor(2,1);
          lcd.print(colorAttempts);
          lcd.setCursor(4,1);
          lcd.print("attempts");
          myservo.write(90);
          delay(1000);
          stage = 3;
        } else{
          colorAttempts += 1;
          lcd.clear();
          lcd.setCursor(2,0);
          lcd.print("wrong!");
          detectedColors = "";
          }
      }
    }
  }


//------------------------------------------------------------------------------


  if (stage == 3) {
    delay(200);
    lcd.clear();
    lcd.setCursor(0,0);
    lcd.print("Your'e the");
    lcd.setCursor(0,1);
    lcd.print("ultimate leader");
  }
}
